<p-panel [header]="profile.data.name" [toggleable]="true">
  <div *ngIf="!removeReason" style="padding: 0px 10px">
    * Reason for change is between the profile and its source from IGAMT
  </div>
  <div style="padding: 5px 10px">
    <strong>Binding Context Legend : </strong>
    <div style="display: flex; flex-direction: row; align-items: center">
      <div
        *ngFor="let item of legend"
        style="
          display: flex;
          flex-direction: row;
          align-items: center;
          margin-right: 5px;
        "
      >
        <app-binding-badge [context]="item.context"></app-binding-badge>
        <span style="margin-left: 5px">{{ item.label }}</span>
      </div>
    </div>
  </div>
  <div class="row" style="border-bottom: 1px solid #d9ecf7">
    <div class="col-12" style="display: flex; padding: 5px 40px">
      <div class="data-dd">
        <!-- <h5 style="line-height: 40px;padding-right: 15px;">Data</h5> -->
        <p-dropdown
          [options]="active === 1 ? fullConfigOptions : segmentConfigOptions"
          appendTo="body"
          [(ngModel)]="selectedConfiguration"
          optionLabel="label"
        ></p-dropdown>
      </div>

      <div class="data-dd" *ngIf="!removeReason">
        <p-toggleButton
          [onLabel]="'Hide Reason'"
          offLabel="Show reason"
          [onIcon]="'pi pi-eye-slash'"
          offIcon="pi pi-eye"
          [(ngModel)]="showReason"
          inputId="reason"
        ></p-toggleButton>
      </div>
      <div class="data-dd">
        <p-toggleButton
          [onLabel]="'Normal view'"
          offLabel="Compliance view"
          [(ngModel)]="compliance"
          inputId="compliance"
        ></p-toggleButton>
      </div>

      <div class="data-dd">
        <!-- <p-toggleButton [onLabel]="'Non-consequential'" offLabel="Consequential" [(ngModel)]="consequential"
          inputId="consequential"></p-toggleButton> -->
        <p-dropdown
          [options]="consequentialOptions"
          [(ngModel)]="consequential"
          optionLabel="label"
          appendTo="body"
        >
        </p-dropdown>
      </div>
    </div>
  </div>
  <ul class="nav nav-pills" style="padding: 15px 10px">
    <li style="cursor: pointer" class="nav-item">
      <span
        class="nav-link active"
        [ngClass]="{ active: activeTab === 'profiles' }"
        (click)="activeTab = 'profiles'"
        >Profile</span
      >
    </li>
    <li style="cursor: pointer" class="nav-item">
      <span
        class="nav-link active"
        [ngClass]="{ active: activeTab === 'segments' }"
        (click)="
          activeTab = 'segments'; active = profile.segmentRefs[0].data.ref
        "
        >Segments</span
      >
    </li>
    <li style="cursor: pointer" class="nav-item">
      <span
        class="nav-link active"
        [ngClass]="{ active: activeTab === 'datatypes' }"
        (click)="activeTab = 'datatypes'"
        >Data types</span
      >
    </li>
  </ul>
  <ng-container *ngIf="activeTab === 'profiles'">
    <!-- <button type="button" class="btn btn-primary" (click)="showConfStatements(profile.conformanceStatements)">
      Show Profile Conformance statements
    </button> -->
    <ng-container *ngIf="selectedConfiguration.name !== 'coConstraint'">
      <ng-container
        *ngIf="selectedConfiguration.name === 'conformanceStatement'"
      >
        <h5 style="padding: 0px 10px">Profile Conformance statements</h5>
        <div style="padding: 25px 0px">
          <app-conformance-statement-viewer
            [conformanceStatements]="profile.conformanceStatements"
            [igs]="igs"
            [results]="results"
          ></app-conformance-statement-viewer>
        </div>
        <h5 style="padding: 0px 10px">Profile structure</h5>
      </ng-container>

      <div>
        <p-treeTable
          [value]="profile.children"
          [scrollable]="true"
          scrollHeight="400px"
          [style]="{ width: '100vw' }"
        >
          <ng-template pTemplate="colgroup" let-columns>
            <colgroup>
              <col style="width: 380px" />
              <col style="width: 200px" />
              <col style="width: 200px" />
              <col style="width: 200px" *ngIf="showReason" />
            </colgroup>

            <colgroup>
              <col style="width: 380px" />
              <col style="width: 200px" />
              <ng-container *ngFor="let derivedIg of igs">
                <col style="width: 200px" />
                <col style="width: 200px" *ngIf="showReason" />
              </ng-container>
            </colgroup>
          </ng-template>
          <ng-template pTemplate="header" let-columns>
            <tr>
              <th style="width: 380px"></th>
              <th style="width: 200px">
                {{ results.srcIg.title }}
                <div class="derived-pill reference">Reference</div>
              </th>
              <th
                style="width: 200px"
                [attr.colspan]="showReason ? 2 : 1"
                *ngFor="let derivedIg of igs"
              >
                {{ derivedIg.title }}
                <div
                  *ngIf="
                    results.srcIg.profileId === derivedIg.profileOrigin &&
                    derivedIg.derived
                  "
                  class="derived-pill derived"
                >
                  Derived
                </div>
                <div
                  *ngIf="
                    results.srcIg.profileId !== derivedIg.profileOrigin ||
                    !derivedIg.derived
                  "
                  class="derived-pill not-derived"
                >
                  Not derived
                </div>
              </th>
            </tr>
            <tr>
              <th style="width: 380px">Name</th>
              <th style="width: 200px">Value</th>
              <ng-container *ngFor="let derivedIg of igs">
                <th style="width: 200px">Value</th>
                <th style="width: 200px" *ngIf="showReason">Reason</th>
              </ng-container>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
            <tr
              *ngIf="
                consequential.name === 'all-changes' ||
                (consequential.name === 'consequential' &&
                  ((!rowNode.parent && rowData?.consequential?.src) ||
                    (rowNode.parent &&
                      rowNode?.parent?.data?.consequential?.src &&
                      rowData?.consequential?.src))) ||
                (consequential.name === 'non-consequential' &&
                  ((!rowNode.parent && !rowData?.consequential?.src) ||
                    (rowNode.parent &&
                      !rowNode?.parent?.data?.consequential?.src &&
                      !rowData?.consequential?.src)))
              "
            >
              <!-- <td style="width: 380px;" [ngClass]="{
                          'row-changed': rowData.changed
                        }"> -->
              <td
                style="width: 380px"
                [ngClass]="{
                  'row-changed':
                    rowData.changeTypes &&
                    rowData.changeTypes.includes(selectedConfiguration.name)
                }"
              >
                <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                <app-data-badge [type]="rowData.type"></app-data-badge>
                {{ rowData.position }}.
                <ng-container *ngIf="rowData.type === 'segmentRef'">
                  {{ rowData.ref }}
                </ng-container>
                <ng-container
                  *ngIf="
                    rowData.type === 'group' ||
                    rowData.type === 'field' ||
                    rowData.type === 'component' ||
                    rowData.type === 'subcomponent'
                  "
                >
                  {{ rowData.name.src?.value }}
                </ng-container>
              </td>
              <td
                *ngIf="
                  selectedConfiguration.name !== 'valueset' &&
                  selectedConfiguration.name !== 'conformanceStatement' &&
                  selectedConfiguration.name !== 'slicing'
                "
              >
                {{
                  rowData[selectedConfiguration.name]?.src?.value
                    ? rowData[selectedConfiguration.name]?.src?.value
                    : ""
                }}
              </td>
              <td *ngIf="selectedConfiguration.name === 'conformanceStatement'">
                <div
                  (click)="showConfStatements(rowData.conformanceStatements)"
                  style="text-align: center"
                  *ngIf="
                    rowData.conformanceStatements &&
                    rowData.conformanceStatements.length > 0
                  "
                >
                  <fa-icon [icon]="['fas', 'eye']"></fa-icon>
                </div>
              </td>
              <td *ngIf="selectedConfiguration.name === 'valueset'">
                <div *ngIf="rowData.bindings">
                  <div *ngFor="let binding of rowData.bindings">
                    <app-valueset-table
                      [valueset]="binding.data"
                      [source]="true"
                    ></app-valueset-table>
                  </div>
                </div>
              </td>
              <td *ngIf="selectedConfiguration.name === 'slicing'">
                <!-- <div *ngIf="rowData.slicing && rowData.slicing.slice">
                  <div *ngFor="let slice of rowData.slicing.slice">Slice</div>
                </div> -->
              </td>

              <ng-container *ngFor="let derivedIg of igs">
                <ng-container
                  *ngIf="
                    selectedConfiguration.name !== 'valueset' &&
                    selectedConfiguration.name !== 'slicing'
                  "
                >
                  <ng-container
                    *ngIf="
                      rowData[selectedConfiguration.name] &&
                      rowData[selectedConfiguration.name].derived &&
                      rowData[selectedConfiguration.name].derived[derivedIg.id]
                    "
                  >
                    <td
                      style="position: relative"
                      [ngClass]="{
                        added:
                          rowData[selectedConfiguration.name].derived[
                            derivedIg.id
                          ].status === 'added',
                        deleted:
                          rowData[selectedConfiguration.name].derived[
                            derivedIg.id
                          ].status === 'deleted',
                        info:
                          (consequential.name === 'all-changes' ||
                            (consequential.name === 'consequential' &&
                              (!rowNode.parent ||
                                (rowNode.parent &&
                                  rowNode?.parent?.data?.consequential?.derived[
                                    derivedIg.id
                                  ]))) ||
                            (consequential.name === 'non-consequential' &&
                              (!rowNode.parent ||
                                (rowNode.parent &&
                                  !rowNode?.parent?.data?.consequential
                                    ?.derived[derivedIg.id])))) &&
                          compliance &&
                          rowData[selectedConfiguration.name].derived[
                            derivedIg.id
                          ].compliance === 'info',
                        warning:
                          (consequential.name === 'all-changes' ||
                            (consequential.name === 'consequential' &&
                              (!rowNode.parent ||
                                (rowNode.parent &&
                                  rowNode?.parent?.data?.consequential?.derived[
                                    derivedIg.id
                                  ]))) ||
                            (consequential.name === 'non-consequential' &&
                              (!rowNode.parent ||
                                (rowNode.parent &&
                                  !rowNode?.parent?.data?.consequential
                                    ?.derived[derivedIg.id])))) &&
                          compliance &&
                          rowData[selectedConfiguration.name].derived[
                            derivedIg.id
                          ].compliance === 'warning',
                        error:
                          (consequential.name === 'all-changes' ||
                            (consequential.name === 'consequential' &&
                              (!rowNode.parent ||
                                (rowNode.parent &&
                                  rowNode?.parent?.data?.consequential?.derived[
                                    derivedIg.id
                                  ]))) ||
                            (consequential.name === 'non-consequential' &&
                              (!rowNode.parent ||
                                (rowNode.parent &&
                                  !rowNode?.parent?.data?.consequential
                                    ?.derived[derivedIg.id])))) &&
                          compliance &&
                          rowData[selectedConfiguration.name].derived[
                            derivedIg.id
                          ].compliance === 'error'
                      }"
                    >
                      <ng-container
                        *ngIf="
                          consequential.name === 'all-changes' ||
                          (consequential.name === 'consequential' &&
                            (!rowNode.parent ||
                              (rowNode.parent &&
                                rowNode?.parent?.data?.consequential?.derived[
                                  derivedIg.id
                                ]))) ||
                          (consequential.name === 'non-consequential' &&
                            (!rowNode.parent ||
                              (rowNode.parent &&
                                !rowNode?.parent?.data?.consequential?.derived[
                                  derivedIg.id
                                ])))
                        "
                      >
                        {{
                          rowData[selectedConfiguration.name].derived[
                            derivedIg.id
                          ].value
                        }}
                        <ng-container
                          *ngIf="
                            selectedConfiguration.name === 'usage' &&
                            rowData[selectedConfiguration.name].derived[
                              derivedIg.id
                            ].value === 'C(A/B)'
                          "
                        >
                          <fa-icon
                            [icon]="faExclamationTriangle"
                            pTooltip="Profile verification error"
                            tooltipPosition="top"
                            style="color: red"
                          ></fa-icon>
                        </ng-container>

                        <div
                          style="
                            position: absolute;
                            right: 15px;
                            top: 7px;
                            cursor: pointer;
                          "
                          (click)="
                            comment(
                              rowData,
                              selectedConfiguration.name,
                              derivedIg.id
                            )
                          "
                        >
                          <i
                            class="pi pi-comments p-mr-4 p-text-secondary"
                            pBadge
                            style="font-size: 2rem"
                          ></i>
                          <div class="comment-badge">
                            <div style="margin: auto">
                              {{
                                rowData[selectedConfiguration.name].derived[
                                  derivedIg.id
                                ].comments
                                  ? rowData[selectedConfiguration.name].derived[
                                      derivedIg.id
                                    ].comments.length
                                  : 0
                              }}
                            </div>
                          </div>

                          <!-- <p-button
                                    label="Comments"
                                    [badge]="
                                      rowData[selectedConfiguration.name].derived[
                                        derivedIg.id
                                      ].comments
                                        ? rowData[selectedConfiguration.name].derived[
                                            derivedIg.id
                                          ].comments.length
                                        : 0
                                    "
                                    styleClass="p-mr-2"
                                  ></p-button> -->
                        </div>
                      </ng-container>
                    </td>
                  </ng-container>
                  <ng-container
                    *ngIf="
                      !rowData[selectedConfiguration.name] ||
                      !rowData[selectedConfiguration.name].derived ||
                      !rowData[selectedConfiguration.name].derived[derivedIg.id]
                    "
                  >
                    <td></td>
                  </ng-container>

                  <td
                    *ngIf="showReason"
                    [ngClass]="{
                      grayed:
                        derivedIg.profileOrigin !== results.srcIg.profileId ||
                        !derivedIg.derived
                    }"
                  >
                    {{
                      rowData.reason &&
                      rowData.reason[derivedIg.id] &&
                      rowData.reason[derivedIg.id][selectedConfiguration.name]
                        ? rowData.reason[derivedIg.id][
                            selectedConfiguration.name
                          ]
                        : ""
                    }}
                    <!-- {{
                              rowData[selectedConfiguration.name]?.derived
                                ? (rowData[selectedConfiguration.name]?.derived)[
                                    derivedIg.id
                                  ]?.reason
                                : ""
                            }} -->
                  </td>
                </ng-container>
                <ng-container *ngIf="selectedConfiguration.name === 'valueset'">
                  <td style="position: relative">
                    <div *ngIf="rowData.bindings">
                      <div *ngFor="let binding of rowData.bindings">
                        <div *ngIf="binding.changed">
                          <app-valueset-table
                            [valueset]="binding.data"
                            [changed]="true"
                            [source]="false"
                            [igId]="derivedIg.id"
                          ></app-valueset-table>
                        </div>

                        <!-- {{
                                  binding.data.strength?.derived
                                    ? (binding.data.strength?.derived)[derivedIg.id]
                                        ?.value
                                    : ""
                                }} -->
                      </div>
                      <div
                        style="
                          position: absolute;
                          right: 15px;
                          top: 7px;
                          cursor: pointer;
                        "
                        (click)="commentVs(rowData, derivedIg.id)"
                      >
                        <i
                          class="pi pi-comments p-mr-4 p-text-secondary"
                          pBadge
                          style="font-size: 2rem"
                        ></i>
                        <div class="comment-badge">
                          <div style="margin: auto">
                            {{
                              rowData.bindingsComments &&
                              rowData.bindingsComments[derivedIg.id]
                                ? rowData.bindingsComments[derivedIg.id].length
                                : 0
                            }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td *ngIf="showReason"></td>
                </ng-container>
                <ng-container *ngIf="selectedConfiguration.name === 'slicing'">
                  <td>
                    <div *ngIf="rowData.slicing && rowData.slicing.changed">
                      <button
                        class="btn btn-sm btn-i"
                        (click)="showSlicing(rowData.slicing, derivedIg.id)"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          height="1em"
                          viewBox="0 0 512 512"
                        >
                          <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                          <path
                            d="M256 192l-39.5-39.5c4.9-12.6 7.5-26.2 7.5-40.5C224 50.1 173.9 0 112 0S0 50.1 0 112s50.1 112 112 112c14.3 0 27.9-2.7 40.5-7.5L192 256l-39.5 39.5c-12.6-4.9-26.2-7.5-40.5-7.5C50.1 288 0 338.1 0 400s50.1 112 112 112s112-50.1 112-112c0-14.3-2.7-27.9-7.5-40.5L499.2 76.8c7.1-7.1 7.1-18.5 0-25.6c-28.3-28.3-74.1-28.3-102.4 0L256 192zm22.6 150.6L396.8 460.8c28.3 28.3 74.1 28.3 102.4 0c7.1-7.1 7.1-18.5 0-25.6L342.6 278.6l-64 64zM64 112a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm48 240a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"
                          />
                        </svg>
                      </button>
                    </div>
                  </td>
                </ng-container>
              </ng-container>
            </tr>
          </ng-template>
        </p-treeTable>
      </div>
    </ng-container>
    <ng-container *ngIf="selectedConfiguration.name === 'coConstraint'">
      <h5 style="padding: 0px 10px">Co-constraints</h5>
      <div style="padding: 25px 0px">
        <app-co-constraint-viewer
          [coConstraints]="profile.coConstraints"
          [igs]="igs"
          [results]="results"
        ></app-co-constraint-viewer>
      </div>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="activeTab === 'segments'">
    <div>
      <p-table [value]="segmentSummaries" dataKey="name">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem"></th>
            <th>Change</th>
            <th *ngFor="let ig of igs">{{ ig.title }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row let-expanded="expanded">
          <tr>
            <td>
              <button
                type="button"
                pButton
                pRipple
                [pRowToggler]="row"
                class="p-button-text p-button-rounded p-button-plain"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              ></button>
            </td>
            <td>{{ row.name }}</td>
            <td *ngFor="let ig of igs">
              {{ row[ig.id] ? row[ig.id].number : 0 }}
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-row>
          <tr>
            <td colspan="4">
              <div class="p-3">
                <p-table [value]="getActiveSegmentChange(row)" dataKey="id">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Name</th>
                      <th *ngFor="let ig of igs">{{ ig.title }}</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-change>
                    <tr>
                      <td>
                        <div style="display: flex">
                          <app-data-badge
                            [type]="'segmentRef'"
                          ></app-data-badge>
                          {{ change.path }} {{ change.name }}
                        </div>
                      </td>
                      <td *ngFor="let ig of igs">
                        {{ change.igs[ig.id] ? "Changed" : "" }}
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </ng-container>
  <ng-container *ngIf="activeTab === 'datatypes'">
    <div>
      <p-table [value]="datatypeSummaries" dataKey="name">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem"></th>
            <th>Change</th>
            <th *ngFor="let ig of igs">{{ ig.title }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row let-expanded="expanded">
          <tr>
            <td>
              <button
                type="button"
                pButton
                pRipple
                [pRowToggler]="row"
                class="p-button-text p-button-rounded p-button-plain"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              ></button>
            </td>
            <td>{{ row.name }}</td>
            <td *ngFor="let ig of igs">
              {{ row[ig.id] ? row[ig.id].number : 0 }}
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-row>
          <tr>
            <td colspan="4">
              <div class="p-3">
                <p-table [value]="getActiveChange(row)" dataKey="id">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Name</th>
                      <th *ngFor="let ig of igs">{{ ig.title }}</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-change>
                    <tr>
                      <td>
                        <div style="display: flex">
                          <app-data-badge [type]="change.type"></app-data-badge>
                          {{ change.path }} {{ change.name }}
                        </div>
                      </td>
                      <td *ngFor="let ig of igs">
                        {{ change.igs[ig.id] ? "Changed" : "" }}
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </ng-container>
</p-panel>
