import { Component, OnInit } from "@angular/core";
import { DifferentialService } from "../../shared/services/differential.service";
import { Router } from "@angular/router";
import { saveAs } from 'file-saver';
import {parse, stringify} from 'flatted';

@Component({
  selector: "app-results",
  templateUrl: "./results.component.html",
  styleUrls: ["./results.component.scss"]
})
export class ResultsComponent implements OnInit {
  results;
  selectedProfile;
  selectedIgs;
  constructor(
    private differentialService: DifferentialService,
    private router: Router
  ) {}

  ngOnInit(): void {
    this.results = this.differentialService.differentialResults;
    // this.results = {"profiles":[{"data":{"name":"IZ22-SEND UNSOLICITED IMMUNIZATION UPDATE USING A VXU","description":"VXU - Unsolicited vaccination record update","title":"IZ22-SEND UNSOLICITED IMMUNIZATION UPDATE USING A VXU-VXU - Unsolicited vaccination record update","id":"5f3c0412c5651ff5bf7a9718"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"PID","idSeg":"5f3c0412c5651ff5bf7a977d","label":"PID_IZ01","description":"Patient Identification","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"PD1","idSeg":"5f3c0412c5651ff5bf7a9771","label":"PD1_IZ","description":"Patient Additional Demographic","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},{"data":{"position":"5","ref":"NK1","idSeg":"5f3c0412c5651ff5bf7a9782","label":"NK1_IZ","description":"Next of Kin / Associated Parties","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},{"data":{"position":"6","name":"PATIENT","usage":{"src":{"value":"O"}},"type":"group"},"children":[{"data":{"position":"1","ref":"PV1","idSeg":"HL7PV1-V2-5-1","label":"PV1","description":"Patient Visit","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"PV2","idSeg":"HL7PV2-V2-5-1","label":"PV2","description":"Patient Visit - Additional Information","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"position":"7","ref":"GT1","idSeg":"HL7GT1-V2-5-1","label":"GT1","description":"Guarantor","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"8","name":"INSURANCE","usage":{"src":{"value":"O"}},"type":"group"},"children":[{"data":{"position":"1","ref":"IN1","idSeg":"5f3c0412c5651ff5bf7a9779","label":"IN1_IZ","description":"Insurance","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"IN2","idSeg":"HL7IN2-V2-5-1","label":"IN2","description":"Insurance Additional Information","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"IN3","idSeg":"HL7IN3-V2-5-1","label":"IN3","description":"Insurance Additional Information, Certification","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"position":"9","name":"ORDER","usage":{"src":{"value":"RE"}},"type":"group"},"children":[{"data":{"position":"1","ref":"ORC","idSeg":"5f3c0412c5651ff5bf7a977e","label":"ORC_IZ01","description":"Common Order","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","name":"TIMING","usage":{"src":{"value":"O"}},"type":"group"},"children":[{"data":{"position":"1","ref":"TQ1","idSeg":"HL7TQ1-V2-5-1","label":"TQ1","description":"Timing/Quantity","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"TQ2","idSeg":"HL7TQ2-V2-5-1","label":"TQ2","description":"Timing/Quantity Relationship","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"position":"3","ref":"RXA","idSeg":"5f3c0412c5651ff5bf7a9773","label":"RXA_IZ01","description":"Pharmacy/Treatment Administration","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"RXR","idSeg":"5f3c0412c5651ff5bf7a976f","label":"RXR_IZ","description":"Pharmacy/Treatment Route","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},{"data":{"position":"5","name":"OBSERVATION","usage":{"src":{"value":"RE"}},"type":"group"},"children":[{"data":{"position":"1","ref":"OBX","idSeg":"5f3c0412c5651ff5bf7a977f","label":"OBX_IZ01","description":"Observation/Result","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"NTE","idSeg":"HL7NTE-V2-5-1","label":"NTE","description":"Notes and Comments","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]}]}]},{"data":{"name":"IZ23RETURN AN ACKNOWLEDGEMENT","description":"General Acknowledgment Message","title":"IZ23RETURN AN ACKNOWLEDGEMENT-General Acknowledgment Message","id":"5f3c0412c5651ff5bf7a971e"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9781","label":"MSH_IZ02","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"MSA","idSeg":"5f3c0412c5651ff5bf7a9778","label":"MSA_IZ01","description":"Message Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"ERR","idSeg":"5f3c0412c5651ff5bf7a9774","label":"ERR_IZ","description":"Error","usage":{"src":{"value":"RE"}},"type":"segmentRef"}}]},{"data":{"name":"IZ31-RETURN A LIST OF CANDIDATES PROFILE","description":"RSP - Segment pattern response in response to QBP^Q11","title":"IZ31-RETURN A LIST OF CANDIDATES PROFILE-RSP - Segment pattern response in response to QBP^Q11","id":"5f3c0412c5651ff5bf7a971d"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"MSA","idSeg":"5f3c0412c5651ff5bf7a9778","label":"MSA_IZ01","description":"Message Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"ERR","idSeg":"5f3c0412c5651ff5bf7a9774","label":"ERR_IZ","description":"Error","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},
    // {"data":{"position":"5","ref":"QAK","idSeg":"5f3c0412c5651ff5bf7a977a","label":"QAK_IZ","description":"Query Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"6","ref":"QPD","idSeg":"5f3c0412c5651ff5bf7a9776","label":"QPD_IZ","description":"Query Parameter Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"7","name":"ROW_DEFINITION","usage":{"src":{"value":"O"}},"type":"group"},"children":[{"data":{"position":"1","ref":"RDF","idSeg":"HL7RDF-V2-5-1","label":"RDF","description":"Table Row Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"RDT","idSeg":"HL7RDT-V2-5-1","label":"RDT","description":"Table Row Data","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"position":"8","ref":"DSC","idSeg":"HL7DSC-V2-5-1","label":"DSC","description":"Continuation Pointer","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"name":"IZ32-RETURN COMPLETE IMMUNIZATION HISTORY","description":"RSP - Segment pattern response in response to QBP^Q11","title":"IZ32-RETURN COMPLETE IMMUNIZATION HISTORY-RSP - Segment pattern response in response to QBP^Q11","id":"5f3c0412c5651ff5bf7a971c"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"MSA","idSeg":"5f3c0412c5651ff5bf7a9772","label":"MSA_IZ02","description":"Message Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"ERR","idSeg":"5f3c0412c5651ff5bf7a9774","label":"ERR_IZ","description":"Error","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},{"data":{"position":"5","ref":"QAK","idSeg":"5f3c0412c5651ff5bf7a977a","label":"QAK_IZ","description":"Query Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"6","ref":"QPD","idSeg":"5f3c0412c5651ff5bf7a9776","label":"QPD_IZ","description":"Query Parameter Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"7","name":"ROW_DEFINITION","usage":{"src":{"value":"O"}},"type":"group"},"children":[{"data":{"position":"1","ref":"RDF","idSeg":"HL7RDF-V2-5-1","label":"RDF","description":"Table Row Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"RDT","idSeg":"HL7RDT-V2-5-1","label":"RDT","description":"Table Row Data","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"position":"8","ref":"DSC","idSeg":"HL7DSC-V2-5-1","label":"DSC","description":"Continuation Pointer","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"name":"IZ33-RETURN AN ACKNOWLEDGEMENT WITH NO PERSON RECORDS","description":"RSP - Segment pattern response in response to QBP^Q11","title":"IZ33-RETURN AN ACKNOWLEDGEMENT WITH NO PERSON RECORDS-RSP - Segment pattern response in response to QBP^Q11","id":"5f3c0412c5651ff5bf7a9719"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"},"derived":{"5f7b35cec5651f449cfdc767":{"value":"RE","reason":""}}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"MSA","idSeg":"5f3c0412c5651ff5bf7a9778","label":"MSA_IZ01","description":"Message Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"ERR","idSeg":"5f3c0412c5651ff5bf7a9774","label":"ERR_IZ","description":"Error","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},{"data":{"position":"5","ref":"QAK","idSeg":"5f3c0412c5651ff5bf7a977a","label":"QAK_IZ","description":"Query Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"6","ref":"QPD","idSeg":"5f3c0412c5651ff5bf7a9776","label":"QPD_IZ","description":"Query Parameter Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"7","name":"ROW_DEFINITION","usage":{"src":{"value":"O"},"derived":{"5f7b35cec5651f449cfdc767":{"value":"RE","reason":""}}},"type":"group"},"children":[{"data":{"position":"1","ref":"RDF","idSeg":"HL7RDF-V2-5-1","label":"RDF","description":"Table Row Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"RDT","idSeg":"HL7RDT-V2-5-1","label":"RDT","description":"Table Row Data","usage":{"src":{"value":"O"},"derived":{"5f7b35cec5651f449cfdc767":{"value":"R","reason":""}}},"type":"segmentRef"}}]},{"data":{"position":"8","ref":"DSC","idSeg":"HL7DSC-V2-5-1","label":"DSC","description":"Continuation Pointer","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"name":"IZ34-REQUEST A COMPLETE IMMUNIZATION HISTORY","description":"QBP - Query by parameter requesting an RSP segment pattern response","title":"IZ34-REQUEST A COMPLETE IMMUNIZATION HISTORY-QBP - Query by parameter requesting an RSP segment pattern response","id":"5f3c0412c5651ff5bf7a971b"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"},"derived":{"5f7b35cec5651f449cfdc767":{"value":"R","reason":""}}},"type":"segmentRef"}},{"data":{"position":"3","ref":"QPD","idSeg":"5f3c0412c5651ff5bf7a9776","label":"QPD_IZ","description":"Query Parameter Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"RCP","idSeg":"5f3c0412c5651ff5bf7a9775","label":"RCP_IZ01","description":"Response Control Parameter","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"5","ref":"DSC","idSeg":"HL7DSC-V2-5-1","label":"DSC","description":"Continuation Pointer","usage":{"src":{"value":"X"}},"type":"segmentRef"}}]},{"data":{"name":"IZ42-RETURN EVALUATED HISTORY AND FORECAST","description":"RSP - Segment pattern response in response to QBP^Q11","title":"IZ42-RETURN EVALUATED HISTORY AND FORECAST-RSP - Segment pattern response in response to QBP^Q11","id":"5f3c0412c5651ff5bf7a971a"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"MSA","idSeg":"5f3c0412c5651ff5bf7a9778","label":"MSA_IZ01","description":"Message Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"ERR","idSeg":"5f3c0412c5651ff5bf7a9774","label":"ERR_IZ","description":"Error","usage":{"src":{"value":"RE"}},"type":"segmentRef"}},{"data":{"position":"5","ref":"QAK","idSeg":"5f3c0412c5651ff5bf7a977a","label":"QAK_IZ","description":"Query Acknowledgment","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"6","ref":"QPD","idSeg":"5f3c0412c5651ff5bf7a9776","label":"QPD_IZ","description":"Query Parameter Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"7","name":"ROW_DEFINITION","usage":{"src":{"value":"O"}},"type":"group"},"children":[{"data":{"position":"1","ref":"RDF","idSeg":"HL7RDF-V2-5-1","label":"RDF","description":"Table Row Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"RDT","idSeg":"HL7RDT-V2-5-1","label":"RDT","description":"Table Row Data","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"position":"8","ref":"DSC","idSeg":"HL7DSC-V2-5-1","label":"DSC","description":"Continuation Pointer","usage":{"src":{"value":"O"}},"type":"segmentRef"}}]},{"data":{"name":"IZ44-REQUEST EVALUATED IMMUNIZATION HISTORY AND FORECAST QUERY PROFILE","description":"QBP - Query by parameter requesting an RSP segment pattern response","title":"IZ44-REQUEST EVALUATED IMMUNIZATION HISTORY AND FORECAST QUERY PROFILE-QBP - Query by parameter requesting an RSP segment pattern response","id":"5f3c0412c5651ff5bf7a9717"},"children":[{"data":{"position":"1","ref":"MSH","idSeg":"5f3c0412c5651ff5bf7a9777","label":"MSH_IZ01","description":"Message Header","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"2","ref":"SFT","idSeg":"HL7SFT-V2-5-1","label":"SFT","description":"Software Segment","usage":{"src":{"value":"O"}},"type":"segmentRef"}},{"data":{"position":"3","ref":"QPD","idSeg":"5f3c0412c5651ff5bf7a9776","label":"QPD_IZ","description":"Query Parameter Definition","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"4","ref":"RCP","idSeg":"5f3c0412c5651ff5bf7a9783","label":"RCP_IZ02","description":"Response Control Parameter","usage":{"src":{"value":"R"}},"type":"segmentRef"}},{"data":{"position":"5","ref":"DSC","idSeg":"HL7DSC-V2-5-1","label":"DSC","description":"Continuation Pointer","usage":{"src":{"value":"X"}},"type":"segmentRef"}}]}],"srcIg":{"title":"diff tool source","id":"5f3c0412c5651ff5bf7a9716"},"derivedIgs":[{"title":"diff tool source[derived]","id":"5f7b35cec5651f449cfdc767"}]}
   
    if (!this.results) {
      this.router.navigate(["/configuration"]);
    } else {
      this.selectedIgs = this.results.derivedIgs;
    }
    console.log(this.results);
  }

  selectProfile(profile) {
    console.log(profile);
    this.selectedProfile = profile;
  }
  updateConfig() {}

  save(){
    console.log(this.results)
    // const blob = new Blob(
    //   [JSON.stringify(this.results)],
    //   { type: "text/json" }
    // );
    const blob = new Blob(
      [stringify(this.results)],
      { type: "text/json" }
    );
    saveAs(blob, 'IACT_report.json');

  }
}
